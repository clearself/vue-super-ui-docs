import{aF as s,e as i,f as a,V as e}from"./chunks/framework.54wzUQT-.js";const F=JSON.parse('{"title":"服务器迁移","description":"","frontmatter":{},"headers":[],"relativePath":"docs/服务端/部署/服务器迁移.md","filePath":"docs/服务端/部署/服务器迁移.md","lastUpdated":1716277301000}'),n={name:"docs/服务端/部署/服务器迁移.md"},t=e(`<h1 id="服务器迁移" tabindex="-1">服务器迁移 <a class="header-anchor" href="#服务器迁移" aria-label="Permalink to &quot;服务器迁移&quot;">​</a></h1><p>实现的功能</p><ul><li>将当前服务器的文件同步至新服务器</li><li>将当前服务器已安装过的软件同步至新服务器</li></ul><h2 id="安装-rsync-同步文件" tabindex="-1">安装 rsync 同步文件 <a class="header-anchor" href="#安装-rsync-同步文件" aria-label="Permalink to &quot;安装 rsync 同步文件&quot;">​</a></h2><p>两台服务器都需要安装</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-Km9my" id="tab-vLs0ktx" checked="checked"><label for="tab-vLs0ktx">Ubuntu/Debian</label><input type="radio" name="group-Km9my" id="tab-lWUIG2_"><label for="tab-lWUIG2_">CentOS/RHEL</label></div><div class="blocks"><div class="language-sh vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get install rsync</span></span></code></pre></div><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yum install rsync</span></span></code></pre></div></div></div><h2 id="rsync-同步至新服务器" tabindex="-1">rsync 同步至新服务器 <a class="header-anchor" href="#rsync-同步至新服务器" aria-label="Permalink to &quot;rsync 同步至新服务器&quot;">​</a></h2><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -avz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [当前服务器的目录,以/结尾] 用户@[目标服务器]:[目标服务器路径,以/结尾]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -avz</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/html/ root@13.1.2.4:/www</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 也可以 / 整个目录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -avz</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> / root@13.1.2.4:/</span></span></code></pre></div><ul><li><code>-avz</code>是 rsync 命令的选项 <ul><li><code>-a</code>：用于保持文件和目录的所有属性和权限</li><li><code>-v</code>：用于在终端显示详细的操作信息，包括文件的复制进度和同步的文件列表</li><li><code>-z</code>：表示在传输文件时使用压缩来减小数据传输的大小。这有助于加快文件传输速度，特别是在通过网络传输大文件时。</li></ul></li></ul><h2 id="rsync-同步时无权限" tabindex="-1">rsync 同步时无权限 <a class="header-anchor" href="#rsync-同步时无权限" aria-label="Permalink to &quot;rsync 同步时无权限&quot;">​</a></h2><p>无权限时会提示下面的错误</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@1.2.3.4:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Permission denied </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publickey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> connection unexpectedly closed </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes received so far</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) [sender]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> error: error in rsync protocol data stream </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">code</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">at io.c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">231</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) [sender=3.2.7]</span></span></code></pre></div><ol><li>这是服务器的公钥与私钥不对导致的，你需要在当前服务器<code>~/.ssh/id_rsa</code>私钥文件与新服务器<code>~/.ssh/authorized_keys</code>公钥文件匹配</li><li>如果没有公钥私钥文件可以使用命令<code>ssh-keygen -t rsa -P &#39;&#39;</code>生成，生成后会出现在当前服务器<code>~/.ssh</code>下，存在<code>id_rsa</code>与<code>id_rsa.pub</code>，把<code>id_rsa.pub</code>文件内容复制到新服务器的<code>~/.ssh/</code>下，并改名为<code>authorized_keys</code></li></ol><h2 id="权限解决后可能会出现秘钥文件权限过于开放" tabindex="-1">权限解决后可能会出现秘钥文件权限过于开放 <a class="header-anchor" href="#权限解决后可能会出现秘钥文件权限过于开放" aria-label="Permalink to &quot;权限解决后可能会出现秘钥文件权限过于开放&quot;">​</a></h2><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Warning:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Permanently added &#39;1.2.3.4&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ED25519) to the list of known hosts.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         WARNING: UNPROTECTED PRIVATE KEY FILE!          @</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Permissions</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0644</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> for &#39;/root/.ssh/id_rsa&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> are too open.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">It</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is required that your private key files are NOT accessible by others.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">This</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> private key will be ignored.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Load</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> key &quot;/root/.ssh/id_rsa&quot;: bad permissions</span></span></code></pre></div><p>修改私钥文件的权限即可</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /root/.ssh/id_rsa</span></span></code></pre></div><h2 id="迁移软件到新服务器" tabindex="-1">迁移软件到新服务器 <a class="header-anchor" href="#迁移软件到新服务器" aria-label="Permalink to &quot;迁移软件到新服务器&quot;">​</a></h2><ul><li>安装程序</li></ul><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #新旧服务器都要安装</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get install apt-clone</span></span></code></pre></div><ul><li>旧服务器执行备份</li></ul><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # back为备份后的文件名</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  apt-clone clone   back  --with-dpkg-repack</span></span></code></pre></div><ul><li>备份后会出现back.apt-clone.tar.gzt文件，把此文件发送到新服务器</li></ul><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可以使用 rsync 传过去，也可以手动下载后传输</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -avz</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /back.apt-clone.tar.gz root@1.2.3.4:/</span></span></code></pre></div><ul><li>新服务器执行安装</li></ul><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># back.apt-clone.tar.gz 就是备份好的文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-clone restore  back.apt-clone.tar.gz</span></span></code></pre></div>`,26),l=[t];function h(p,k,d,r,c,o){return i(),a("div",null,l)}const y=s(n,[["render",h]]);export{F as __pageData,y as default};
